#!/bin/sh
# postinst script for udm-boot
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
       echo "Create udm-boot file structure"
       /sbin/ssh-proxy 'mkdir -p /mnt/data/udm-boot'
       scp -P "$(cat /etc/unifi-os/ssh_proxy_port)" -o StrictHostKeyChecking=no -q /usr/share/udm-boot/host/* root@localhost:/mnt/data/udm-boot/
       /sbin/ssh-proxy 'chmod +x /mnt/data/udm-boot/*.sh'
       /sbin/ssh-proxy '/mnt/data/udm-boot/install.sh'

       # enable and start udm-boot
       echo "Enable udm-boot services"
       deb-systemd-invoke enable udm-boot.service
       deb-systemd-invoke enable udm-boot-script.service
       deb-systemd-invoke start udm-boot.service
       deb-systemd-invoke start udm-boot-script.service

       echo ""
       echo ""
       echo "udm-boot container started on the udm."
       echo ""
       echo "if possible do not use podman on the udm directly"
       echo "to change the state of the udm-boot container."
       echo "Use systemctl in the unifi-os container for this."
       echo "Otherwise you have to take care of /run/udm-boot.service-cid"
       echo "by yourself before it can be started again."
       echo ""
       echo "some example commands to manage it from inside the unifi-os shell:"
       echo ""
       echo "  - systemctl start udm-boot"
       echo "  - systemctl stop udm-boot"
       echo "  - systemctl restart udm-boot"
       echo "  - systemctl status udm-boot"
       echo "  - ssh-proxy podman logs udm-boot"
       echo "  - ssh-proxy podman exec -it udm-boot /bin/bash"
       echo ""


    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
